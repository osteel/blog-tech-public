<!DOCTYPE html>
<html lang="en">
  <head>
      <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"/>
    <link rel="shortcut icon" type="image/x-icon" href="https://tech.osteel.me/favicon.ico" />

    <meta name="author" content="Yannick Chenot"/>
    <meta property="og:image" content="https://tech.osteel.me/images/2022/06/30/workflow_00.png" />

    <meta name="google-site-verification" content="KhtQOQ0ZVgZ55KSEoXMOWo_seu_e_JbV6xBk_SuewYI" />

    <meta name="monetization" content="$ilp.uphold.com/miU94ZyFdQ6K">

    <title>A GitHub workflow to check the compatibility of your PHP package with a range of dependency versions &mdash; osteel's blog</title>

    <meta charset="utf-8" />
    <link href="https://tech.osteel.me/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="osteel's blog Full Atom Feed" />
    <link href="https://tech.osteel.me/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="osteel's blog Full RSS Feed" />
    <link href="https://tech.osteel.me/feeds/atom.xml" type="application/atom+xml" rel="alternate" title="osteel's blog Atom Feed" />
    <link href="https://tech.osteel.me/feeds/rss.xml" type="application/rss+xml" rel="alternate" title="osteel's blog RSS Feed" />
    <link rel="stylesheet" href="https://tech.osteel.me/theme/css/poole.css"/>
    <link rel="stylesheet" href="https://tech.osteel.me/theme/css/syntax.css"/>
    <link rel="stylesheet" href="https://tech.osteel.me/theme/css/lanyon.css"/>
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">
    <link rel="stylesheet" href="https://tech.osteel.me/theme/css/styles.css"/>

    <script
      type="text/javascript"
      src="https://platform-api.sharethis.com/js/sharethis.js#property=5e6053b434311400122fd1f8&product=inline-share-buttons"
      async="async">
    </script>



  <meta name="description" content="A common aspect of a PHP developer's job is to deal with Composer dependencies. We don't usually need to think about supporting various versions of these dependencies, just as we don't need to think about accommodating a range of PHP versions. Things are different for open-source software maintainers – they need to ensure their libraries will work with as many environments as possible. This post explores one way of automating compatibility testing, using a combination of test coverage and a GitHub workflow." />
  <meta name="twitter:description" content="A common aspect of a PHP developer's job is to deal with Composer dependencies. We don't usually need to think about supporting various versions of these dependencies, just as we don't need to think about accommodating a range of PHP versions. Things are different for open-source software maintainers – they need to ensure their libraries will work with as many environments as possible. This post explores one way of automating compatibility testing, using a combination of test coverage and a GitHub workflow.">

  <meta name="tags" content="github" />
  <meta name="tags" content="workflow" />
  <meta name="tags" content="composer" />
  <meta name="tags" content="compatibilitytesting" />

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@osteel">
  <meta name="twitter:creator" content="@osteel">
  <meta name="twitter:title" content="A GitHub workflow to check the compatibility of your PHP package with a range of dependency versions">
  <meta name="twitter:image" content="https://tech.osteel.me/images/2022/06/30/workflow_00.png">

  </head>

  <body>
<!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">
<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <div class="profile">
      <img src="https://www.gravatar.com/avatar/158eb527bb4ceb8e1a84e74b39815b71"/>
    </div>
  </div>

  <section>
    <p>Demat ! I'm Yannick, a senior backend developer based in Brighton, UK.</p>
  </section>

  <section>
    <ul class="sidebar-nav">
    </ul>
  </section>

  <section>
    <h2>Newsletter</h2>
    <form class="sidebar-nav-item sidebar-nav" action="https://osteel.us5.list-manage.com/subscribe/post?u=dda32a39af10ca5ed21d00084&amp;id=e1b6d5529d" method="post" name="mc-embedded-subscribe-form" target="_blank" novalidate>
      <input type="email" value="" name="EMAIL" id="mce-EMAIL" class="form-input" placeholder="Email address" required>
      <input type="checkbox" value="" name="group[23889][2]" style="display:none" checked>
      <input type="submit" hidden />
      <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
      <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_dda32a39af10ca5ed21d00084_e1b6d5529d" tabindex="-1" value=""></div>
    </form>
  </section>

  <section>
    <h2>Categories</h2>
    <nav class="sidebar-nav">
        <a class="sidebar-nav-item" href="https://tech.osteel.me/category/blogging">Blogging</a>
        <a class="sidebar-nav-item" href="https://tech.osteel.me/category/business">Business</a>
        <a class="sidebar-nav-item" href="https://tech.osteel.me/category/devops">DevOps</a>
        <a class="sidebar-nav-item" href="https://tech.osteel.me/category/laravel">Laravel</a>
        <a class="sidebar-nav-item" href="https://tech.osteel.me/category/misc">Misc</a>
        <a class="sidebar-nav-item" href="https://tech.osteel.me/category/php">PHP</a>
        <a class="sidebar-nav-item" href="https://tech.osteel.me/category/productivity">Productivity</a>

    </nav>
  </section>

  <section>
    <h2>Search</h2>
    <form class="sidebar-nav-item sidebar-nav" action="https://tech.osteel.me/search.html" onsubmit="return (this.elements['q'].value.length > 0)">
        <input class="form-input" type="text" name="q" placeholder="Search" />
    </form>
  </section>

    <section>
        <h2>Find me</h2>
        <ul class="sidebar-nav">
            <li><a class="sidebar-nav-item" href="https://github.com/osteel" target="_blank">GitHub</a></li>
            <li><a class="sidebar-nav-item" href="https://twitter.com/osteel" target="_blank">Twitter</a></li>
            <li><a class="sidebar-nav-item" href="https://www.linkedin.com/in/yannickchenot" target="_blank">LinkedIn</a></li>
        </ul>
    </section>

  <section>
    <h2>Feeds</h2>
    <ul class="sidebar-nav">
      <li class="sidebar-nav-item">All posts&nbsp;
        [&nbsp;
 <a href="https://tech.osteel.me/feeds/atom.xml" rel="subscribe-atom">Atom</a>        &nbsp;
 <a href="https://tech.osteel.me/feeds/rss.xml" rel="subscribe-rss">RSS</a>        &nbsp;]
      </li>
    </ul>
  </section>

  <div class="sidebar-item">
    <p>
    <a href="https://twitter.com/osteel">&copy; @osteel</a> 2022
    </p>
    <p class="tiny-note">
      Powered by <a href="http://getpelican.com">Pelican</a> :: Theme based on <a class="muted" href="https://github.com/thomaswilley/pelicanyan">Pelicanyan</a>
    </p>
  </div>
</div>    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="https://tech.osteel.me/" title="Home">osteel's blog</a>
            <small>Web development resources</small>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="posts">
<div class="post">
    <h1 class="post-title">
      A GitHub workflow to check the compatibility of your PHP package with a range of dependency versions
    </h1>
    <span class="post-date">
      <small>
          Last updated: 2022-08-17 ::
        Published: 2022-06-30
          :: [ <a href="https://github.com/osteel/blog-tech-public/commits/master/posts/a-github-workflow-to-check-the-compatibility-of-your-php-package-with-a-range-of-dependency-versions.html">history</a> ]
      </small>
    </span>

    <section class="info">
      <span class="title">Been here before?</span>
      <form action="https://osteel.us5.list-manage.com/subscribe/post?u=dda32a39af10ca5ed21d00084&amp;id=e1b6d5529d" method="post" id="subscribe-form" name="mc-embedded-subscribe-form" target="_blank" novalidate>
        <label for="mce-EMAIL">Get notified of future posts by email:</label>
        <input type="email" value="" name="EMAIL" id="mce-EMAIL" class="form-input" placeholder="email address" required>
        <input type="submit" value="Sign up" name="subscribe" id="mc-embedded-subscribe" class="form-button">
        <input type="checkbox" value="" name="group[23889][2]" style="display:none" checked>
        <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
        <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_dda32a39af10ca5ed21d00084_e1b6d5529d" tabindex="-1" value=""></div>
      </form>
      <p>You can also subscribe to the <a href="https://tech.osteel.me/feeds/rss.xml" rel="subscribe-rss">RSS</a> or <a href="https://tech.osteel.me/feeds/atom.xml" rel="subscribe-atom">Atom</a> feed, or follow me on <a href="https://twitter.com/osteel">Twitter</a>.</p>
    </section>

    <p><img alt="Successful workflow run" src="/images/2022/06/30/workflow_00.png" title="Successful workflow run" /></p>
<p>A common aspect of a PHP developer's job is to deal with <a href="https://getcomposer.org/">Composer</a> dependencies. We use the work of others as Lego bricks to build our own projects, making the most of the beautiful thing that is the open-source movement.</p>
<p>As typical end-users of these community efforts, we maintain a list of dependencies whose versions are <em>pinned</em> through the <code>composer.lock</code> file. We don't need to think about supporting other versions of these dependencies, just as we don't need to think about accommodating a range of PHP versions – we work within the constraints of our application's target environments, which are known and expected to be stable over time.</p>
<p>Things are different for open-source software maintainers. They are largely agnostic to the constraints of their users' environments, so the best they can do is make sure their libraries are compatible with as many PHP and dependency versions as possible.</p>
<p>This is where compatibility testing is crucial. Open-source maintainers need to ensure that any change made to the code will work with all the versions listed in <code>composer.json</code>. Doing so manually is unpractical, so they resort to test coverage and automated scripts.</p>
<p>This post explores one such way of automating compatibility testing, using a combination of test coverage and a <a href="https://docs.github.com/en/actions/using-workflows">GitHub Actions workflow</a>.</p>
<h2 id="in-this-post">In this post</h2>
<div class="toc">
<ul>
<li><a href="#in-this-post">In this post</a></li>
<li><a href="#complete-workflow">Complete workflow</a></li>
<li><a href="#breakdown">Breakdown</a><ul>
<li><a href="#initial-setup">Initial setup</a></li>
<li><a href="#library-and-test-coverage">Library and test coverage</a></li>
<li><a href="#basic-workflow">Basic workflow</a></li>
<li><a href="#dependency-ranges">Dependency ranges</a></li>
<li><a href="#testing-lower-dependency-versions">Testing lower dependency versions</a></li>
</ul>
</li>
<li><a href="#closing-thoughts">Closing thoughts</a></li>
<li><a href="#resources">Resources</a></li>
</ul>
</div>
<h2 id="complete-workflow">Complete workflow</h2>
<p>Here is the final version of the workflow. If you're just here for the code, feel free to copy and reuse the below as much as you please. Otherwise keep reading for a progressive breakdown of the file, supported by an example project.</p>
<p>You can also check out this article's <a href="https://github.com/osteel/php-compatibility-demo">repository</a> for reference.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">CI</span>

<span class="nt">on</span><span class="p">:</span>
  <span class="nt">push</span><span class="p">:</span>
    <span class="nt">branches</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">main</span><span class="p p-Indicator">]</span>
  <span class="nt">pull_request</span><span class="p">:</span>
    <span class="nt">branches</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">main</span><span class="p p-Indicator">]</span>

<span class="nt">jobs</span><span class="p">:</span>

  <span class="nt">phpunit</span><span class="p">:</span>
    <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">PHPUnit</span>
    <span class="nt">runs-on</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>

    <span class="nt">strategy</span><span class="p">:</span>
      <span class="nt">fail-fast</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
      <span class="nt">matrix</span><span class="p">:</span>
        <span class="nt">php-version</span><span class="p">:</span>
          <span class="p p-Indicator">-</span> <span class="s">&quot;7.4&quot;</span>
          <span class="p p-Indicator">-</span> <span class="s">&quot;8.0&quot;</span>
          <span class="p p-Indicator">-</span> <span class="s">&quot;8.1&quot;</span>
        <span class="nt">dependency-versions</span><span class="p">:</span>
          <span class="p p-Indicator">-</span> <span class="s">&quot;lowest&quot;</span>
          <span class="p p-Indicator">-</span> <span class="s">&quot;highest&quot;</span>

    <span class="nt">steps</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Checkout</span>
        <span class="nt">uses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">actions/checkout@v3</span>

      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Setup PHP</span>
        <span class="nt">uses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">shivammathur/setup-php@v2</span>
        <span class="nt">with</span><span class="p">:</span>
          <span class="nt">php-version</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${{ matrix.php-version }}</span>
          <span class="nt">coverage</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">none</span>

      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Install composer dependencies</span>
        <span class="nt">uses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ramsey/composer-install@v2</span>
        <span class="nt">with</span><span class="p">:</span>
          <span class="nt">dependency-versions</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${{ matrix.dependency-versions }}</span>

      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Run PHPUnit</span>
        <span class="nt">run</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">vendor/bin/phpunit tests</span>
</pre></div>
</td></tr></table>

<h2 id="breakdown">Breakdown</h2>
<p>The following is a full breakdown of the workflow. We will build it up incrementally, using an example project that we will update as we expand the range of supported dependency versions.</p>
<h3 id="initial-setup">Initial setup</h3>
<p>This step is optional, but if you're a "learn through practice" kind of person, you may want to build this example project on your machine and update it as we go. If you don't, you may want to read this section anyway, as it contains some relevant information.</p>
<p>If you do, go ahead and <a href="https://github.com/new">create</a> a new empty GitHub repository now. Call it <code>php-compatibility-demo</code> (or anything else if you feel inspired) and make sure it's public so you can enjoy the free GitHub Actions <a href="https://docs.github.com/en/billing/managing-billing-for-github-actions/about-billing-for-github-actions">allowance</a> (unless you've got a paid account, in which case feel free to keep the repository private).</p>
<p class="info"><span class="title">Development setup</span> The below assumes that your development setup supports PHP 8.0+ and that you've got access to a terminal with Composer and Git.</p>

<p>Clone the repository on your development machine and initialise a new Composer project:</p>
<div class="highlight"><pre><span></span>$ git clone php-compatibility-demo
$ <span class="nb">cd</span> php-compatibility-demo
$ composer init
</pre></div>


<p>The last command will ask you a series of questions and generate a <code>composer.json</code> file at the end. Most questions don't matter in the context of this article, but make sure to select <a href="https://getcomposer.org/doc/04-schema.md#type"><em>library</em></a> for the type of project, <a href="https://getcomposer.org/doc/04-schema.md#minimum-stability"><em>stable</em></a> for the minimum stability, and to leave the default values for the PSR-4 autoload bit.</p>
<p>Once that's done, add <code>/vendor/</code> and <code>composer.lock</code> to the <code>.gitignore</code> file:</p>
<div class="highlight"><pre><span></span>/vendor/
composer.lock
</pre></div>


<p>This is the first major difference from regular company projects, where developers will usually commit the <code>composer.lock</code> file so the application is consistent across environments. Here we embrace inconsistency instead, and let Composer figure out what dependency versions to use based on the constraints of client environments.</p>
<p>In this context, the GitHub workflow is yet another client environment, and we don't want it to pick up a <code>composer.lock</code> file that will force the installation of specific versions while our goal is to test a whole range of them.</p>
<h3 id="library-and-test-coverage">Library and test coverage</h3>
<p>With that in place, let's talk about our test project for a minute. We are going to build a small library on top of <a href="https://github.com/moneyphp/money">Money</a>, a popular PHP package facilitating the manipulation of monetary values and currencies.</p>
<p>Our library will consist of a single helper class – <code>CurrencyHelper.php</code> – that will simplify working with currencies. It will expose two methods – one to make sure that a bunch of <code>Money</code> objects have the same currency, and another one returning the <a href="https://en.wikipedia.org/wiki/ISO_4217#Active_codes">numeric ISO 4217 code</a> of a <code>Money</code> object.</p>
<p>You will soon realise that this library is pretty pointless, but it makes up a good example to support this article, so I trust you will turn a blind eye.</p>
<p>Here's the file structure you should get at the end of this section (remember that you can also refer to this article's <a href="https://github.com/osteel/php-compatibility-demo">repository</a> at any time for comparison):</p>
<div class="highlight"><pre><span></span>php-compatibility-demo/
├── src/
│   └── CurrencyHelper.php
├── tests/
│   └── CurrencyHelperTest.php
├── vendor/
├── .gitignore
├── composer.json
└── composer.lock
</pre></div>


<p>Let's instal the Money library:</p>
<div class="highlight"><pre><span></span>$ composer require moneyphp/money:^4.0
</pre></div>


<p>Note that we intentionally import v4 here, even though it may not be the latest version when you're reading this.</p>
<p>Let's also instal <a href="https://phpunit.de/">PHPUnit</a> as a development dependency:</p>
<div class="highlight"><pre><span></span>$ composer require --dev phpunit/phpunit
</pre></div>


<p>Now create the <code>src/CurrencyHelper.php</code> file:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="k">namespace</span> <span class="nx">Osteel\PhpCompatibilityDemo</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Money\Currencies\ISOCurrencies</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Money\Money</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">CurrencyHelper</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">isSame</span><span class="p">(</span><span class="nx">Money</span> <span class="o">...</span><span class="nv">$amounts</span><span class="p">)</span><span class="o">:</span> <span class="nx">bool</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="nv">$amounts</span><span class="p">)</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nv">$first</span> <span class="o">=</span> <span class="nb">array_shift</span><span class="p">(</span><span class="nv">$amounts</span><span class="p">);</span>

        <span class="k">return</span> <span class="nv">$first</span><span class="o">-&gt;</span><span class="na">isSameCurrency</span><span class="p">(</span><span class="o">...</span><span class="nv">$amounts</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">numericCode</span><span class="p">(</span><span class="nx">Money</span> <span class="nv">$amount</span><span class="p">)</span><span class="o">:</span> <span class="nx">int</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="p">(</span><span class="k">new</span> <span class="nx">ISOCurrencies</span><span class="p">())</span><span class="o">-&gt;</span><span class="na">numericCodeFor</span><span class="p">(</span><span class="nv">$amount</span><span class="o">-&gt;</span><span class="na">getCurrency</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<p>If you're also building this example library on your machine, don't forget to update the vendor name in the namespace at the top.</p>
<p>The <code>isSame</code> method takes any number of <code>Money</code> objects and returns a boolean indicating whether they share the same currency. The way it works is that it removes the first element from the array (using <a href="https://www.php.net/manual/en/function.array-shift"><code>array_shift</code></a>) and then compares this element's currency with that of the other ones, using the <code>isSameCurrency</code> method from the <code>Money</code> class.</p>
<p>The second method – <code>numericCode</code> – takes a <code>Money</code> object as its only parameter and returns its currency's numeric ISO code, using the <code>numericCodeFor</code> method from the <code>ISOCurrencies</code> helper class (which is part of the Money library).</p>
<p>And here is the content for <code>tests/CurrencyHelperTest.php</code>, the class testing the behaviour of our "library":</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="k">namespace</span> <span class="nx">Osteel\PhpCompatibilityDemo\Tests</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Money\Money</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Osteel\PhpCompatibilityDemo\CurrencyHelper</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">PHPUnit\Framework\TestCase</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">CurrencyHelperTest</span> <span class="k">extends</span> <span class="nx">TestCase</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">testItReturnsWhetherCurrenciesAreTheSame</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$helper</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CurrencyHelper</span><span class="p">();</span>

        <span class="nv">$amount1</span> <span class="o">=</span> <span class="nx">Money</span><span class="o">::</span><span class="na">EUR</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
        <span class="nv">$amount2</span> <span class="o">=</span> <span class="nx">Money</span><span class="o">::</span><span class="na">EUR</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
        <span class="nv">$amount3</span> <span class="o">=</span> <span class="nx">Money</span><span class="o">::</span><span class="na">EUR</span><span class="p">(</span><span class="mi">15</span><span class="p">);</span>
        <span class="nv">$amount4</span> <span class="o">=</span> <span class="nx">Money</span><span class="o">::</span><span class="na">USD</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertTrue</span><span class="p">(</span><span class="nv">$helper</span><span class="o">-&gt;</span><span class="na">isSame</span><span class="p">(</span><span class="nv">$amount1</span><span class="p">,</span> <span class="nv">$amount2</span><span class="p">));</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertTrue</span><span class="p">(</span><span class="nv">$helper</span><span class="o">-&gt;</span><span class="na">isSame</span><span class="p">(</span><span class="nv">$amount1</span><span class="p">,</span> <span class="nv">$amount2</span><span class="p">,</span> <span class="nv">$amount3</span><span class="p">));</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertFalse</span><span class="p">(</span><span class="nv">$helper</span><span class="o">-&gt;</span><span class="na">isSame</span><span class="p">(</span><span class="nv">$amount1</span><span class="p">,</span> <span class="nv">$amount4</span><span class="p">));</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertFalse</span><span class="p">(</span><span class="nv">$helper</span><span class="o">-&gt;</span><span class="na">isSame</span><span class="p">(</span><span class="nv">$amount1</span><span class="p">,</span> <span class="nv">$amount2</span><span class="p">,</span> <span class="nv">$amount4</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">testItReturnsNumericCode</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$helper</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CurrencyHelper</span><span class="p">();</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="mi">978</span><span class="p">,</span> <span class="nv">$helper</span><span class="o">-&gt;</span><span class="na">numericCode</span><span class="p">(</span><span class="nx">Money</span><span class="o">::</span><span class="na">EUR</span><span class="p">(</span><span class="mi">10</span><span class="p">)));</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="mi">840</span><span class="p">,</span> <span class="nv">$helper</span><span class="o">-&gt;</span><span class="na">numericCode</span><span class="p">(</span><span class="nx">Money</span><span class="o">::</span><span class="na">USD</span><span class="p">(</span><span class="mi">10</span><span class="p">)));</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<p>These tests will allow us to confirm whether our library works with various PHP and dependency versions later on. Again, don't forget to update the vendor's name at the top.</p>
<p>Let's check that the tests are passing:</p>
<div class="highlight"><pre><span></span>$ ./vendor/bin/phpunit tests
</pre></div>


<p>If they do, we can move on to the workflow.</p>
<h3 id="basic-workflow">Basic workflow</h3>
<p>Let's start with a simple GitHub Actions workflow whose only job will be to run the test suite. Basically what we just did, but in an automated way.</p>
<p>We need to create a new <code>.github</code> folder at the root of the project, itself containing a <code>workflows</code> folder in which we add a file named <code>ci.yml</code>. These directories are GitHub conventions – that's where the platform expects to find our workflows, <code>ci.yml</code> being one of them.</p>
<p>This is the updated file structure:</p>
<div class="highlight"><pre><span></span>php-compatibility-demo/
├── .github/
│   └── workflows/
│       └── ci.yml
├── src/
│   └── CurrencyHelper.php
├── tests/
│   └── CurrencyHelperTest.php
├── vendor/
├── .gitignore
├── composer.json
└── composer.lock
</pre></div>


<p>And here's the content of <code>ci.yml</code>:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">CI</span>

<span class="nt">on</span><span class="p">:</span>
  <span class="nt">push</span><span class="p">:</span>
    <span class="nt">branches</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">main</span><span class="p p-Indicator">]</span>
  <span class="nt">pull_request</span><span class="p">:</span>
    <span class="nt">branches</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">main</span><span class="p p-Indicator">]</span>

<span class="nt">jobs</span><span class="p">:</span>

  <span class="nt">phpunit</span><span class="p">:</span>
    <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">PHPUnit</span>
    <span class="nt">runs-on</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>

    <span class="nt">steps</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Checkout</span>
        <span class="nt">uses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">actions/checkout@v3</span>

      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Setup PHP</span>
        <span class="nt">uses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">shivammathur/setup-php@v2</span>
        <span class="nt">with</span><span class="p">:</span>
          <span class="nt">coverage</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">none</span>

      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Install composer dependencies</span>
        <span class="nt">uses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ramsey/composer-install@v2</span>

      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Run PHPUnit</span>
        <span class="nt">run</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">vendor/bin/phpunit tests</span>
</pre></div>
</td></tr></table>

<p>Let's break it down quickly – we first give the workflow a name ("CI" stands for "Continuous Integration"), and then define the conditions on which it should trigger (here, any changes pushed to the <code>main</code> branch, or any pull request opened towards it).</p>
<p>We then list the jobs to be executed. There's only one in our case – running the test suite. We call this job "PHPUnit" and specify that it will run on the latest Ubuntu version.</p>
<p>Then we define the steps making up the job – checking out the code, setting up PHP, installing the Composer dependencies and, finally, running the test suite. The first three steps are using popular GitHub Actions (see the <code>uses</code> keys):</p>
<ul>
<li><a href="https://github.com/actions/checkout">Checkout</a>;</li>
<li><a href="https://github.com/shivammathur/setup-php">Setup PHP</a>;</li>
<li><a href="https://github.com/ramsey/composer-install">Composer Install</a>.</li>
</ul>
<p>We don't need a GitHub Action for the last step as it is a simple command.</p>
<p>Save the file, commit and push. After a few seconds, you should see a screen similar to this under the <em>Actions</em> tab of your GitHub repository:</p>
<p><img alt="Successful basic workflow" src="/images/2022/06/30/workflow_01.png" title="Successful basic workflow" />
<p class="caption">You can click on the workflow run to see the logs</p></p>
<p>And that's it for the first version of our workflow. It's a decent first step already, as the workflow will trigger any time some new code is pushed to/a pull request is opened towards <code>main</code>, automatically reporting any breaking changes.</p>
<p>But so far we're only testing a single set of dependency versions – whatever Composer decides is best when the workflow reaches the <em>Install composer dependencies</em> step.</p>
<p>Let's go one step further.</p>
<h3 id="dependency-ranges">Dependency ranges</h3>
<p>Say we want to support both PHP 7.4+ and PHP 8.0+. Instead of letting Composer do its best based on what software version is available on the client environment, we are going to tip it off by explicitly listing the PHP versions our library is compatible with.</p>
<p>Open <code>composer.json</code> and update the <code>require</code> section as follows:</p>
<div class="highlight"><pre><span></span><span class="s2">&quot;require&quot;</span><span class="err">:</span> <span class="p">{</span>
    <span class="nt">&quot;php&quot;</span><span class="p">:</span> <span class="s2">&quot;^7.4|^8.0&quot;</span><span class="p">,</span>
    <span class="nt">&quot;moneyphp/money&quot;</span><span class="p">:</span> <span class="s2">&quot;^4.0&quot;</span>
<span class="p">}</span><span class="err">,</span>
</pre></div>


<p>We're now supporting both PHP 7.4+ and PHP 8.0+. But wait, that's not going to work – the Money library <a href="https://github.com/moneyphp/money/blob/v4.0.0/composer.json#L27">requires PHP 8.0+</a> for its v4, so if we want to add support for PHP 7.4+, we also need to include an older version of Money.</p>
<p>Let's update <code>composer.json</code> again:</p>
<div class="highlight"><pre><span></span><span class="s2">&quot;require&quot;</span><span class="err">:</span> <span class="p">{</span>
    <span class="nt">&quot;php&quot;</span><span class="p">:</span> <span class="s2">&quot;^7.4|^8.0&quot;</span><span class="p">,</span>
    <span class="nt">&quot;moneyphp/money&quot;</span><span class="p">:</span> <span class="s2">&quot;^3.0|^4.0&quot;</span>
<span class="p">}</span><span class="err">,</span>
</pre></div>


<p>We're now also supporting both Money v3 and v4. As Money v3 <a href="https://github.com/moneyphp/money/blob/3.x/composer.json#L27">needs PHP 5.6+</a>, we should be compatible with PHP 7.4 as well.</p>
<p>As we've updated <code>composer.json</code>, let's make sure our local <code>composer.lock</code> is up to date with the following command:</p>
<div class="highlight"><pre><span></span>$ composer update --lock
</pre></div>


<p>We now need to update our workflow to ensure the test suite will run for both versions of PHP:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">CI</span>

<span class="nt">on</span><span class="p">:</span>
  <span class="nt">push</span><span class="p">:</span>
    <span class="nt">branches</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">main</span><span class="p p-Indicator">]</span>
  <span class="nt">pull_request</span><span class="p">:</span>
    <span class="nt">branches</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">main</span><span class="p p-Indicator">]</span>

<span class="nt">jobs</span><span class="p">:</span>

  <span class="nt">phpunit</span><span class="p">:</span>
    <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">PHPUnit</span>
    <span class="nt">runs-on</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>

    <span class="nt">strategy</span><span class="p">:</span>
      <span class="nt">fail-fast</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
      <span class="nt">matrix</span><span class="p">:</span>
        <span class="nt">php-version</span><span class="p">:</span>
          <span class="p p-Indicator">-</span> <span class="s">&quot;7.4&quot;</span>
          <span class="p p-Indicator">-</span> <span class="s">&quot;8.0&quot;</span>
          <span class="p p-Indicator">-</span> <span class="s">&quot;8.1&quot;</span>

    <span class="nt">steps</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Checkout</span>
        <span class="nt">uses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">actions/checkout@v3</span>

      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Setup PHP</span>
        <span class="nt">uses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">shivammathur/setup-php@v2</span>
        <span class="nt">with</span><span class="p">:</span>
          <span class="nt">php-version</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${{ matrix.php-version }}</span>
          <span class="nt">coverage</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">none</span>

      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Install composer dependencies</span>
        <span class="nt">uses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ramsey/composer-install@v2</span>

      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Run PHPUnit</span>
        <span class="nt">run</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">vendor/bin/phpunit tests</span>
</pre></div>
</td></tr></table>

<p>The main change here is the addition of the <code>strategy</code> section. A <a href="https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#jobsjob_idstrategy">strategy</a> allows us to define a <a href="https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#jobsjob_idstrategymatrix">matrix</a> for our jobs – a way to run the steps using different configurations.</p>
<p>But let's have a quick look at <code>fail-fast</code> first – by setting this <a href="https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#jobsjob_idstrategyfail-fast">property</a> to <code>false</code>, we make sure the steps will run for all configurations and won't be interrupted even if one of them fails. We want comprehensive feedback for all PHP versions here, so we can fix any issue that comes up.</p>
<p>Then comes the <code>matrix</code> section, composed of a single <code>php-version</code> key, which is an array of values. What that does is that for each successive run of the steps, the <code>php-version</code> key will be assigned a new value from the array, until we reach the end of the array.</p>
<p>Note that we've also listed PHP 8.1 in there, as there are some <a href="https://www.php.net/releases/8.1/en.php">notable differences</a> with PHP 8.0.</p>
<p>We can see the <code>php-version</code> key being referenced further down, in the <em>Setup PHP</em> step. We added a new <code>php-version</code> key under the <code>with</code> section – that's where we assign the value of the current run (<code>${{ matrix.php-version }}</code>), using a <a href="https://github.com/shivammathur/setup-php#php-version-required">configuration option</a> from the Setup PHP GitHub Action.</p>
<p>Let's try this out – commit and push the changes and head over to the repository's <em>Actions</em> tab again. Give it a few seconds – you should see that this time, the run has failed:</p>
<p><img alt="Failed intermediate workflow" src="/images/2022/06/30/workflow_02.png" title="Failed intermediate workflow" /></p>
<p>Click on the workflow run – there was an issue with the PHP 7.4 job:</p>
<p><img alt="Failed intermediate workflow – PHP 7.4" src="/images/2022/06/30/workflow_03.png" title="Failed intermediate workflow – PHP 7.4" /></p>
<p>Click on it and expand the <em>Run PHPUnit</em> logs:</p>
<p><img alt="Failed intermediate workflow – PHP 7.4 logs" src="/images/2022/06/30/workflow_04.png" title="Failed intermediate workflow – PHP 7.4 logs" /></p>
<p>Interesting. One of our test assertions is failing on line 23:</p>
<div class="highlight"><pre><span></span><span class="x">$this-&gt;assertFalse($checker-&gt;isSame($amount1, $amount2, $amount4));</span>
</pre></div>


<p>Looking at the Money library's <a href="https://github.com/moneyphp/money/blob/master/CHANGELOG.md">changelog</a>, the reason appears to be because the <code>Money@isSameCurrency</code> method only added support for multiple arguments <a href="https://github.com/moneyphp/money/blob/v4.0.0/CHANGELOG.md#changed">from v4</a>. We know that this version can only be used with PHP 8.0+, which explains why Composer instals Money v3 when it detects PHP 7.4.</p>
<p>To fix the issue, we need to change the way the <code>isSame</code> method works in <code>CurrencyHelper.php</code>:</p>
<div class="highlight"><pre><span></span><span class="x">public function isSame(Money ...$amounts): bool</span>
<span class="x">{</span>
<span class="x">    if (count($amounts) === 1) {</span>
<span class="x">        return true;</span>
<span class="x">    }</span>

<span class="x">    $first = array_shift($amounts);</span>

<span class="x">    foreach ($amounts as $amount) {</span>
<span class="x">        if (! $first-&gt;isSameCurrency($amount)) {</span>
<span class="x">            return false;</span>
<span class="x">        }</span>
<span class="x">    }</span>

<span class="x">    return true;</span>
<span class="x">}</span>
</pre></div>


<p>Instead of passing all the remaining elements of the <code>$amounts</code> array to <code>isSameCurrency</code> at once, we now loop through them and compare their currency to that of the first element, one by one.</p>
<p>Let's make sure we haven't broken our library before pushing our changes:</p>
<div class="highlight"><pre><span></span>$ ./vendor/bin/phpunit tests
</pre></div>


<p>Commit and push and check the <em>Actions</em> tab again:</p>
<p><img alt="Successful intermediate workflow" src="/images/2022/06/30/workflow_05.png" title="Successful intermediate workflow" /></p>
<p>The error is gone!</p>
<p>So it appears our library is now compatible with both PHP 7.4+ and PHP 8.0+.</p>
<p>Or is it?</p>
<h3 id="testing-lower-dependency-versions">Testing lower dependency versions</h3>
<p>Let's take a look at the logs again. Click on the latest successful workflow run and enter the <em>PHPUnit (7.4)</em> job from the left-hand side. Expand the <em>Install composer dependencies</em> logs and look for the line referencing the Money library.</p>
<p>It looks like Composer is picking the latest minor version by default (v3.3.1 at the time of writing):</p>
<p><img alt="Composer picks the latest version" src="/images/2022/06/30/workflow_06.png" title="Composer picks the latest version" /></p>
<p>The issue is we want our library to be compatible with previous versions as well – how can we force Composer to instal the lowest version – v3.0.0?</p>
<p>We need to update <code>ci.yml</code> again:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">CI</span>

<span class="nt">on</span><span class="p">:</span>
  <span class="nt">push</span><span class="p">:</span>
    <span class="nt">branches</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">main</span><span class="p p-Indicator">]</span>
  <span class="nt">pull_request</span><span class="p">:</span>
    <span class="nt">branches</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">main</span><span class="p p-Indicator">]</span>

<span class="nt">jobs</span><span class="p">:</span>

  <span class="nt">phpunit</span><span class="p">:</span>
    <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">PHPUnit</span>
    <span class="nt">runs-on</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>

    <span class="nt">strategy</span><span class="p">:</span>
      <span class="nt">fail-fast</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
      <span class="nt">matrix</span><span class="p">:</span>
        <span class="nt">php-version</span><span class="p">:</span>
          <span class="p p-Indicator">-</span> <span class="s">&quot;7.4&quot;</span>
          <span class="p p-Indicator">-</span> <span class="s">&quot;8.0&quot;</span>
          <span class="p p-Indicator">-</span> <span class="s">&quot;8.1&quot;</span>
        <span class="nt">dependency-versions</span><span class="p">:</span>
          <span class="p p-Indicator">-</span> <span class="s">&quot;lowest&quot;</span>
          <span class="p p-Indicator">-</span> <span class="s">&quot;highest&quot;</span>

    <span class="nt">steps</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Checkout</span>
        <span class="nt">uses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">actions/checkout@v3</span>

      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Setup PHP</span>
        <span class="nt">uses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">shivammathur/setup-php@v2</span>
        <span class="nt">with</span><span class="p">:</span>
          <span class="nt">php-version</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${{ matrix.php-version }}</span>
          <span class="nt">coverage</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">none</span>

      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Install composer dependencies</span>
        <span class="nt">uses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ramsey/composer-install@v2</span>
        <span class="nt">with</span><span class="p">:</span>
          <span class="nt">dependency-versions</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${{ matrix.dependency-versions }}</span>

      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Run PHPUnit</span>
        <span class="nt">run</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">vendor/bin/phpunit tests</span>
</pre></div>
</td></tr></table>

<p>Note that we've added a new key to our matrix – <code>dependency-versions</code>. It is also an array, with two values – <code>lowest</code> and <code>highest</code>.</p>
<p>This time we're taking advantage of a <a href="https://github.com/ramsey/composer-install#dependency-versions">configuration option</a> from the Composer Install GitHub Action, allowing us to force Composer to either use the lowest or highest versions of the dependencies.</p>
<p>We can see the <code>dependency-versions</code> key being used further down, in the <em>Install composer dependencies</em> step. We added a new <code>with</code> section to it, with a single <code>dependency-versions</code> key to which we assign the current value from the matrix (<code>${{ matrix.dependency-versions }}</code>).</p>
<p>When that value is <code>lowest</code>, the Composer Install GitHub Action will run this command behind the scenes:</p>
<div class="highlight"><pre><span></span>$ composer update --prefer-lowest --prefer-stable
</pre></div>


<p>What's the consequence of adding a new array of values to our matrix? The answer is that it will trigger as many step runs as there are combinations from both arrays.</p>
<p>Let's see it in action – commit and push the new workflow, and check the <em>Actions</em> tab again:</p>
<p><img alt="Failed advanced workflow" src="/images/2022/06/30/workflow_07.png" title="Failed advanced workflow" /></p>
<p>Looks like there was an issue with the new run. If we click on it, we'll see that the test suite was run for each PHP and dependency version, as well as for each value from the <code>dependency-versions</code> array.</p>
<p>But all the runs using the <code>lowest</code> value have failed:</p>
<p><img alt="Failed advanced workflow – lowest dependencies" src="/images/2022/06/30/workflow_08.png" title="Failed advanced workflow – lowest dependencies" /></p>
<p>Let's find out why. Click on the <em>PHPUnit (7.4, lowest)</em> job and expand the <em>Run PHPUnit</em> logs:</p>
<p><img alt="Failed advanced workflow – lowest dependencies logs" src="/images/2022/06/30/workflow_09.png" title="Failed advanced workflow – lowest dependencies logs" /></p>
<p>The error is the following:</p>
<div class="highlight"><pre><span></span>Call to undefined method Money<span class="se">\C</span>urrencies<span class="se">\I</span>SOCurrencies::numericCodeFor<span class="o">()</span>
</pre></div>


<p>If we take a look at the Money library's changelog again, we can see that this method was <a href="https://github.com/moneyphp/money/blob/v4.0.0/CHANGELOG.md#305---2017-04-26">added with v3.0.5</a>.</p>
<p>We now have two ways to fix this – either we update the <code>CurrencyHelper@numericCode</code> method and manually implement <a href="https://github.com/moneyphp/money/compare/v3.0.4...v3.0.5#diff-0631517d385a0d04aa9dbc68ee7e92163b406e084208483ab1837c3ace4bb7f1">the change</a>, or we bump the minimum supported version to 3.0.5.</p>
<p>Since this version is a small <a href="https://semver.org/#summary">patch</a>, it feels reasonable to do the latter.</p>
<p>Let's update <code>composer.json</code> one last time:</p>
<div class="highlight"><pre><span></span><span class="s2">&quot;require&quot;</span><span class="err">:</span> <span class="p">{</span>
    <span class="nt">&quot;php&quot;</span><span class="p">:</span> <span class="s2">&quot;^7.4|^8.0&quot;</span><span class="p">,</span>
    <span class="nt">&quot;moneyphp/money&quot;</span><span class="p">:</span> <span class="s2">&quot;^3.0.5|^4.0&quot;</span>
<span class="p">}</span><span class="err">,</span>
</pre></div>


<p>Commit and push, and wait for the workflow run to finish:</p>
<p><img alt="Successful advanced workflow" src="/images/2022/06/30/workflow_10.png" title="Successful advanced workflow" /></p>
<p>No more errors!</p>
<p>For good measure, let's make sure our local <code>composer.lock</code> is in sync with <code>composer.json</code> again:</p>
<div class="highlight"><pre><span></span>$ composer update --lock
</pre></div>


<h2 id="closing-thoughts">Closing thoughts</h2>
<p>Compatibility testing highlights once again the importance of having good test coverage for our applications. Even if we don't need to support a range of dependency versions, whenever we find ourselves in need to update one of them, having a strong test suite gives us the confidence that it won't break some parts of our code. That also goes for upgrading to a newer PHP version.</p>
<p>But then again, most PHP developers don't have to think about this too much. I personally started to look into compatibility testing more seriously when I created <a href="https://github.com/osteel/openapi-httpfoundation-testing">my first open-source library</a> and, later on, when I started exploring <a href="https://tech.osteel.me/posts/how-to-build-and-distribute-beautiful-command-line-applications-with-php-and-composer">building for the console with PHP</a>.</p>
<p>Yet you may eventually find yourself in a situation where you need to build and provide a PHP package with limited knowledge of target environments. Be it in the context of a private company or as a way to contribute back to the community, when that day comes it may be useful to have this kind of guide handy.</p>
<h2 id="resources">Resources</h2>
<ul>
<li><a href="https://github.com/osteel/php-compatibility-demo">Article repository</a></li>
<li><a href="https://docs.github.com/en/actions">GitHub Actions documentation</a></li>
<li><a href="https://docs.github.com/en/actions/using-workflows">GitHub Actions workflows documentation</a></li>
<li><a href="https://github.com/actions/checkout">Checkout (GitHub Action)</a></li>
<li><a href="https://github.com/shivammathur/setup-php">Setup PHP (GitHub Action)</a></li>
<li><a href="https://github.com/ramsey/composer-install">Composer Install (GitHub Action)</a></li>
<li><a href="https://github.com/moneyphp/money">PHP Money library</a></li>
</ul>

    <div class="sharethis-inline-share-buttons"></div>

    <section class="info">
      <span class="title">Enjoying the content?</span>
      <form action="https://osteel.us5.list-manage.com/subscribe/post?u=dda32a39af10ca5ed21d00084&amp;id=e1b6d5529d" method="post" id="subscribe-form" name="mc-embedded-subscribe-form" target="_blank" novalidate>
        <label for="mce-EMAIL">Get notified of future posts by email:</label>
        <input type="email" value="" name="EMAIL" id="mce-EMAIL" class="form-input" placeholder="email address" required>
        <input type="submit" value="Sign up" name="subscribe" id="mc-embedded-subscribe" class="form-button">
        <input type="checkbox" value="" name="group[23889][2]" style="display:none" checked>
        <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
        <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_dda32a39af10ca5ed21d00084_e1b6d5529d" tabindex="-1" value=""></div>
      </form>
      <p>You can also subscribe to the <a href="https://tech.osteel.me/feeds/rss.xml" rel="subscribe-rss">RSS</a> or <a href="https://tech.osteel.me/feeds/atom.xml" rel="subscribe-atom">Atom</a> feed, or follow me on <a href="https://twitter.com/osteel">Twitter</a>.</p>
    </section>

    <p class="meta">
      <small>
        Last updated by osteel on
          <time datetime="2022-08-17" pubdate>2022-08-17</time>
          :: [
          <a href="https://tech.osteel.me/tag/github">github</a>
          <a href="https://tech.osteel.me/tag/workflow">workflow</a>
          <a href="https://tech.osteel.me/tag/composer">composer</a>
          <a href="https://tech.osteel.me/tag/compatibilitytesting">compatibilitytesting</a>
          ]
      </small>
    </p>

    <section>
      <h2>Comments</h2>
      <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
    </section>
  </div>
</div>
      </div>

      <label for="sidebar-checkbox" class="sidebar-toggle"></label>

      <script>
        (function(document) {
          var i = 0;
          // snip empty header rows since markdown can't
          var rows = document.querySelectorAll('tr');
          for(i=0; i<rows.length; i++) {
            var ths = rows[i].querySelectorAll('th');
            var rowlen = rows[i].children.length;
            if (ths.length > 0 && ths.length === rowlen) {
              rows[i].remove();
            }
          }
        })(document);
      </script>

      <script>
        /* Lanyon & Poole are Copyright (c) 2014 Mark Otto. Adapted to Pelican 20141223 and extended a bit by @thomaswilley */
        (function(document) {
          var toggle = document.querySelector('.sidebar-toggle');
          var sidebar = document.querySelector('#sidebar');
          var checkbox = document.querySelector('#sidebar-checkbox');
          document.addEventListener('click', function(e) {
            var target = e.target;
            if(!checkbox.checked ||
            sidebar.contains(target) ||
            (target === checkbox || target === toggle)) return;
            checkbox.checked = false;
            }, false);
            })(document);
      </script>


      <script type="text/javascript">
        var disqus_shortname = "osteel";
              var disqus_identifier = "/posts/a-github-workflow-to-check-the-compatibility-of-your-php-package-with-a-range-of-dependency-versions";
              var disqus_url = "https://tech.osteel.me/posts/a-github-workflow-to-check-the-compatibility-of-your-php-package-with-a-range-of-dependency-versions";
              var disqus_title = "A GitHub workflow to check the compatibility of your PHP package with a range of dependency versions";
        (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
         })();
      </script>

    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-53994673-2']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();

    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53994673-2');
    ga('send', 'pageview');
</script>

     </div>
  </body>
</html>