<!DOCTYPE html>
<html lang="en">
  <head>
      <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"/>
    <link rel="shortcut icon" type="image/x-icon" href="https://tech.osteel.me/favicon.ico" />

    <meta name="author" content="Yannick Chenot"/>
    <meta property="og:image" content="https://tech.osteel.me/images/year/month/day/" />

    <meta name="google-site-verification" content="KhtQOQ0ZVgZ55KSEoXMOWo_seu_e_JbV6xBk_SuewYI" />

    <meta name="monetization" content="$ilp.uphold.com/miU94ZyFdQ6K">

    <title>Building a PHP CLI tool using DDD and Event Sourcing. Part 3: code design &mdash; osteel's blog</title>

    <meta charset="utf-8" />
    <link href="https://tech.osteel.me/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="osteel's blog Full Atom Feed" />
    <link href="https://tech.osteel.me/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="osteel's blog Full RSS Feed" />
    <link href="https://tech.osteel.me/feeds/atom.xml" type="application/atom+xml" rel="alternate" title="osteel's blog Atom Feed" />
    <link href="https://tech.osteel.me/feeds/rss.xml" type="application/rss+xml" rel="alternate" title="osteel's blog RSS Feed" />
    <link rel="stylesheet" href="https://tech.osteel.me/theme/css/poole.css"/>
    <link rel="stylesheet" href="https://tech.osteel.me/theme/css/syntax.css"/>
    <link rel="stylesheet" href="https://tech.osteel.me/theme/css/lanyon.css"/>
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">
    <link rel="stylesheet" href="https://tech.osteel.me/theme/css/styles.css"/>

    <script
      type="text/javascript"
      src="https://platform-api.sharethis.com/js/sharethis.js#property=5e6053b434311400122fd1f8&product=inline-share-buttons"
      async="async">
    </script>




  <meta name="tags" content="" />

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@osteel">
  <meta name="twitter:creator" content="@osteel">
  <meta name="twitter:title" content="Building a PHP CLI tool using DDD and Event Sourcing. Part 3: code design">
  <meta name="twitter:image" content="https://tech.osteel.me/images/year/month/day/">

  </head>

  <body>
<!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">
<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <div class="profile">
      <img src="https://www.gravatar.com/avatar/158eb527bb4ceb8e1a84e74b39815b71"/>
    </div>
  </div>

  <section>
    <p>Demat ! I'm Yannick, a senior backend developer based in Brighton, UK.</p>
  </section>

  <section>
    <ul class="sidebar-nav">
    </ul>
  </section>

  <section>
    <h2>Newsletter</h2>
    <form class="sidebar-nav-item sidebar-nav" action="https://osteel.us5.list-manage.com/subscribe/post?u=dda32a39af10ca5ed21d00084&amp;id=e1b6d5529d" method="post" name="mc-embedded-subscribe-form" target="_blank" novalidate>
      <input type="email" value="" name="EMAIL" id="mce-EMAIL" class="form-input" placeholder="Email address" required>
      <input type="checkbox" value="" name="group[23889][2]" style="display:none" checked>
      <input type="submit" hidden />
      <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
      <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_dda32a39af10ca5ed21d00084_e1b6d5529d" tabindex="-1" value=""></div>
    </form>
  </section>

  <section>
    <h2>Categories</h2>
    <nav class="sidebar-nav">
        <a class="sidebar-nav-item" href="https://tech.osteel.me/category/blogging">Blogging</a>
        <a class="sidebar-nav-item" href="https://tech.osteel.me/category/business">Business</a>
        <a class="sidebar-nav-item" href="https://tech.osteel.me/category/devops">DevOps</a>
        <a class="sidebar-nav-item" href="https://tech.osteel.me/category/laravel">Laravel</a>
        <a class="sidebar-nav-item" href="https://tech.osteel.me/category/misc">Misc</a>
        <a class="sidebar-nav-item" href="https://tech.osteel.me/category/php">PHP</a>
        <a class="sidebar-nav-item" href="https://tech.osteel.me/category/productivity">Productivity</a>

    </nav>
  </section>

  <section>
    <h2>Search</h2>
    <form class="sidebar-nav-item sidebar-nav" action="https://tech.osteel.me/search.html" onsubmit="return (this.elements['q'].value.length > 0)">
        <input class="form-input" type="text" name="q" placeholder="Search" />
    </form>
  </section>

    <section>
        <h2>Find me</h2>
        <ul class="sidebar-nav">
            <li><a class="sidebar-nav-item" href="https://github.com/osteel" target="_blank">GitHub</a></li>
            <li><a class="sidebar-nav-item" href="https://twitter.com/osteel" target="_blank">Twitter</a></li>
            <li><a class="sidebar-nav-item" href="https://www.linkedin.com/in/yannickchenot" target="_blank">LinkedIn</a></li>
        </ul>
    </section>

  <section>
    <h2>Feeds</h2>
    <ul class="sidebar-nav">
      <li class="sidebar-nav-item">All posts&nbsp;
        [&nbsp;
 <a href="https://tech.osteel.me/feeds/atom.xml" rel="subscribe-atom">Atom</a>        &nbsp;
 <a href="https://tech.osteel.me/feeds/rss.xml" rel="subscribe-rss">RSS</a>        &nbsp;]
      </li>
    </ul>
  </section>

  <div class="sidebar-item">
    <p>
    <a href="https://twitter.com/osteel">&copy; @osteel</a> 2022
    </p>
    <p class="tiny-note">
      Powered by <a href="http://getpelican.com">Pelican</a> :: Theme based on <a class="muted" href="https://github.com/thomaswilley/pelicanyan">Pelicanyan</a>
    </p>
  </div>
</div>    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="https://tech.osteel.me/" title="Home">osteel's blog</a>
            <small>Web development resources</small>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="posts">
<div class="post">
    <h1 class="post-title">
      Building a PHP CLI tool using DDD and Event Sourcing. Part 3: code design
    </h1>
    <span class="post-date">
      <small>
          Last updated: 1970-01-01 ::
        Published: 1970-01-01
          :: [ <a href="https://github.com/osteel/blog-tech-public/commits/master/drafts/a-crypto-activity-tracking-tool-part-3-code-design.html">history</a> ]
      </small>
    </span>

    <section class="info">
      <span class="title">Been here before?</span>
      <form action="https://osteel.us5.list-manage.com/subscribe/post?u=dda32a39af10ca5ed21d00084&amp;id=e1b6d5529d" method="post" id="subscribe-form" name="mc-embedded-subscribe-form" target="_blank" novalidate>
        <label for="mce-EMAIL">Get notified of future posts by email:</label>
        <input type="email" value="" name="EMAIL" id="mce-EMAIL" class="form-input" placeholder="email address" required>
        <input type="submit" value="Sign up" name="subscribe" id="mc-embedded-subscribe" class="form-button">
        <input type="checkbox" value="" name="group[23889][2]" style="display:none" checked>
        <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
        <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_dda32a39af10ca5ed21d00084_e1b6d5529d" tabindex="-1" value=""></div>
      </form>
      <p>You can also subscribe to the <a href="https://tech.osteel.me/feeds/rss.xml" rel="subscribe-rss">RSS</a> or <a href="https://tech.osteel.me/feeds/atom.xml" rel="subscribe-atom">Atom</a> feed, or follow me on <a href="https://twitter.com/osteel">Twitter</a>.</p>
    </section>

    <p><img alt="Caption" src="/images//.jpg" title="Caption" /></p>
<p class="info"><span class="title">Title</span> Content</p>

<div class="info"><p><span class="title">Title</span> Content</p></div>

<p>Plain code block:</p>
<div class="highlight"><pre><span></span>
</pre></div>


<p>Code block with line numbers:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span>
</pre></div>
</td></tr></table>

<p>When I started this series, I wasn't sure whether I would need to write this post. What I'm calling "code design" here is technically still part of the model, and when searching for inspiration online I found many examples where the model contained proper implementation details. But the model is also supposed to be understood by domain experts – how can we expect them to know what a repository or an aggregate root is?</p>
<p>I decided to use this as a guideline and to draw the line between what non-developers would and wouldn't understand, effectively making a distinction between the <em>abstract</em> model (the previous post) and the <em>implementation</em> model (this post). This allows me to go as technical as I wish in the latter, without constraints.</p>
<h2 id="in-this-post">In this post</h2>
<div class="toc">
<ul>
<li><a href="#in-this-post">In this post</a></li>
<li><a href="#domain-driven-design">Domain-Driven Design</a></li>
<li><a href="#event-sourcing">Event Sourcing</a></li>
<li><a href="#layered-architecture">Layered architecture</a></li>
<li><a href="#code-design">Code design</a></li>
<li><a href="#misc-to-sort-out">Misc (to sort out)</a></li>
</ul>
</div>
<h2 id="domain-driven-design">Domain-Driven Design</h2>
<p>https://www.mirkosertic.de/blog/2012/07/domain-driven-design-overview-and-building-blocks/</p>
<p>Entity:</p>
<p>Value object:</p>
<h2 id="event-sourcing">Event Sourcing</h2>
<p>"A pragmatic introduction to Event Sourcing" https://www.youtube.com/watch?v=xHbP3bshU3U</p>
<p>Diagrams:</p>
<p>(state) =&gt; [action] =&gt; (new state)</p>
<p>When the operation is over, we're only left with the new state.</p>
<p>(state) =&gt; [action]
|event| &lt;====/
|event|
|event|</p>
<p>Aggregate: a group of objects that are held together through an entity, called an aggregate root. An aggregate is reconstituted to be ready to make decisions. An aggregate is a subset of events.</p>
<p>Event: something that happened in the past, immutable. Value object. Recorded on the aggregate, to <em>reconstitute</em> the aggregate.</p>
<p>Aggregate root repository: for storing recorded events and reconstituting aggregates.</p>
<p>Message: wrapper for an event containing additional metadata (aggregate ID, event type, etc.).</p>
<p>Message repository: persist and retrieve messages. Can work with any storage type.</p>
<p>Message dispatcher: transport messages. RabbitMQ, Kafka, sync, whatever.</p>
<p>Projection (consumer): reacts to events and use their data to create read models (views).</p>
<p>Read model: view of the event data, optimised for reading.</p>
<h2 id="layered-architecture">Layered architecture</h2>
<p>Layered architecture – presentation, application, domain, infrastructure.</p>
<p>Presentation: console input output, commands (Laravel ones)</p>
<p>Application: jobs, concrete (Eloquent) repositories, providers, exceptions</p>
<p>Domain: entities, aggregates, value objects, services, factories, repository interfaces, consumers (projectors), read models (projections)</p>
<p>Infrastructure: config, storage, database, queues, eloquent models, vendors</p>
<h2 id="code-design">Code design</h2>
<p>In fact, the concept of tax year is a good candidate for an <em>aggregate root</em> – the main entity of an aggregate, a group of domain objects treated as a single unit. In our case, this aggregate would comprise the tax year as well as its relevant taxable events.</p>
<p>"Imagine our domain use-case contains sending an e-mail, but our domain is not about sending emails. Then we can create an interface that will do the sending e-mail use-case. We use this interface in the domain layer and thus keep the domain layer clean, separated.</p>
<p>Another typical domain interface is a repository."</p>
<p>– https://medium.com/carvago-development/domain-driven-design-handbook-4d34b069bec4</p>
<p>Value objects: transactions</p>
<p>Entities/aggregates: tax years, section 104 pools, nft pools</p>
<p>Tax year events: capitalGainRealised, capitalLossRealised, incomeEarned, nonAttributableAllowableCostGenerated</p>
<p>Projection for tax years to get current capital gains, income and non-attributable allowable costs without having to replay all events.</p>
<p>Section 104 pool events: poolingAssetAcquired, poolingAssetDisposedOf, poolingAssetMatchedForSameDayRule, poolingAssetMatchedFor30DaysRule</p>
<p>Projection for section 104 pools to get average cost bases without having to replay all events.</p>
<p>Nft pool events: nftAcquired, nftCostBasisUpdated</p>
<p>Projection for NFT pools to get final cost basis without having to replay all events.</p>
<p>Projections: capital gains, income, non-attributable allowable costs</p>
<p>Services: pooling (with rules – same-day, 30-days and section 104 pool), fee handler</p>
<p>Diagram</p>
<h2 id="misc-to-sort-out">Misc (to sort out)</h2>
<p>Submitting a spreadsheet erases existing records and starts over.</p>
<p>Only two bounded contexts belong to the application – <em>submit</em> and <em>review</em>. Make modules out of them?</p>
<p>Once the job is dispatched, record and report errors at the end instead of interrupting the import?</p>
<p>Use the "sync" driver for events.</p>
<p>dime process transactions.csv</p>
<p>=&gt; do you want to review now?</p>
<p>=&gt; do you want to export now?</p>
<p>dime review</p>
<p>=&gt; please import some transactions first</p>
<p>=&gt; do you want to export now?</p>
<p>dime export</p>
<p>=&gt; please import some transactions first</p>

    <div class="sharethis-inline-share-buttons"></div>

    <section class="info">
      <span class="title">Enjoying the content?</span>
      <form action="https://osteel.us5.list-manage.com/subscribe/post?u=dda32a39af10ca5ed21d00084&amp;id=e1b6d5529d" method="post" id="subscribe-form" name="mc-embedded-subscribe-form" target="_blank" novalidate>
        <label for="mce-EMAIL">Get notified of future posts by email:</label>
        <input type="email" value="" name="EMAIL" id="mce-EMAIL" class="form-input" placeholder="email address" required>
        <input type="submit" value="Sign up" name="subscribe" id="mc-embedded-subscribe" class="form-button">
        <input type="checkbox" value="" name="group[23889][2]" style="display:none" checked>
        <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
        <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_dda32a39af10ca5ed21d00084_e1b6d5529d" tabindex="-1" value=""></div>
      </form>
      <p>You can also subscribe to the <a href="https://tech.osteel.me/feeds/rss.xml" rel="subscribe-rss">RSS</a> or <a href="https://tech.osteel.me/feeds/atom.xml" rel="subscribe-atom">Atom</a> feed, or follow me on <a href="https://twitter.com/osteel">Twitter</a>.</p>
    </section>

    <p class="meta">
      <small>
        Last updated by osteel on
          <time datetime="1970-01-01" pubdate>1970-01-01</time>
          :: [
          <a href="https://tech.osteel.me/tag/"></a>
          ]
      </small>
    </p>

  </div>
</div>
      </div>

      <label for="sidebar-checkbox" class="sidebar-toggle"></label>

      <script>
        (function(document) {
          var i = 0;
          // snip empty header rows since markdown can't
          var rows = document.querySelectorAll('tr');
          for(i=0; i<rows.length; i++) {
            var ths = rows[i].querySelectorAll('th');
            var rowlen = rows[i].children.length;
            if (ths.length > 0 && ths.length === rowlen) {
              rows[i].remove();
            }
          }
        })(document);
      </script>

      <script>
        /* Lanyon & Poole are Copyright (c) 2014 Mark Otto. Adapted to Pelican 20141223 and extended a bit by @thomaswilley */
        (function(document) {
          var toggle = document.querySelector('.sidebar-toggle');
          var sidebar = document.querySelector('#sidebar');
          var checkbox = document.querySelector('#sidebar-checkbox');
          document.addEventListener('click', function(e) {
            var target = e.target;
            if(!checkbox.checked ||
            sidebar.contains(target) ||
            (target === checkbox || target === toggle)) return;
            checkbox.checked = false;
            }, false);
            })(document);
      </script>


      <script type="text/javascript">
        var disqus_shortname = "osteel";
              var disqus_identifier = "/drafts/a-crypto-activity-tracking-tool-part-3-code-design";
              var disqus_url = "https://tech.osteel.me/drafts/a-crypto-activity-tracking-tool-part-3-code-design";
              var disqus_title = "Building a PHP CLI tool using DDD and Event Sourcing. Part 3: code design";
        (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
         })();
      </script>

    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-53994673-2']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();

    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53994673-2');
    ga('send', 'pageview');
</script>

     </div>
  </body>
</html>